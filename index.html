<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Ù†Ø´Ø§Ø· Ø§Ù„Ø®ÙˆØ§Ø±Ø²Ù…ÙŠØ§Øª â€” Ù†Ø³Ø®Ø© Ù…Ø¨Ø³Ø·Ø© (Ø¨Ø¯ÙˆÙ† API)</title>
  <style>
/* Happy Classroom Theme (Ù…Ø®ØªØµØ±Ø©) */
*{box-sizing:border-box}
:root{
  --bg:#fff9fb; --card:#ffffff; --ink:#222; --muted:#6b7280;
  --brand:#8b5cf6; --brand-2:#f472b6; --ok:#10b981; --warn:#f59e0b;
  --ring: 0 10px 30px rgba(139,92,246,.15);
}
html,body{height:100%}
body{
  font-family: system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;
  margin:0; padding:0;
  background:
    radial-gradient(1200px 400px at -10% -10%, #ffe4f0 0, transparent 50%),
    radial-gradient(900px 400px at 110% -10%, #e9e0ff 0, transparent 50%),
    var(--bg);
  color:var(--ink);
}
header,footer{background: linear-gradient(90deg, #fef6ff, #fff7fb);border-bottom:1px solid #f1e8ff;padding:18px 24px}
footer{border-top:1px solid #f1e8ff; border-bottom:none; color:var(--muted)}

h1{margin:6px 0 2px; font-weight:900; letter-spacing:.2px;
  background: linear-gradient(90deg, var(--brand), var(--brand-2));
  -webkit-background-clip:text; background-clip:text; color:transparent;
}
h2{margin:4px 0 10px; font-weight:800}

main{display:grid; grid-template-columns:repeat(auto-fit,minmax(340px,1fr)); gap:16px; padding:16px; align-items:start}
.panel{background:var(--card); border:1px solid #f1e8ff; border-radius:16px; padding:16px; box-shadow: var(--ring)}

/* Ø¹Ù†Ø§ØµØ± ØªØ­ÙƒÙ… */
.controls{display:grid; gap:8px}
.controls .row{display:grid; gap:6px}
.addons{display:flex; flex-wrap:wrap; gap:8px}
.addon{display:inline-flex; align-items:center; gap:6px; padding:8px 10px; border:1px dashed #d9ccff; border-radius:999px; background:#fbfaff; cursor:pointer}
.addon input{accent-color: var(--brand)}

/* Ø§Ù„Ù…ÙƒÙˆÙ†Ø§Øª ÙˆØ§Ù„Ø³Ø­Ø¨ */
.list{display:flex;flex-wrap:wrap;gap:10px;min-height:56px}
.item{background:#f4f0ff; border:1px dashed #c9b8ff; border-radius:999px; padding:10px 14px; cursor:grab; font-weight:700; display:flex; align-items:center; gap:10px; transition:.15s transform ease, .15s box-shadow ease, .15s background ease; box-shadow: var(--ring)}
.item:hover{ transform: translateY(-2px); background:#efe7ff }
.item:active{ cursor:grabbing }
.item .emoji{width:28px;height:28px;border-radius:50%; display:grid;place-items:center;font-size:18px; background:#ffffff;border:1px solid #e9ddff}
.item.bad{ border-color:#fecaca; background:#fff1f2 }
.item.good{ border-color:#bbf7d0; background:#f0fdf4 }

.dropzone{min-height:260px; border:2px dashed #e5d8ff; border-radius:16px; padding:14px; display:flex; flex-direction:column; gap:10px; justify-content:flex-end; background:linear-gradient(180deg,#fff,#fff7ff); position:relative}
.dropzone .dz-item{background:#fffdf5; border:1px solid #ffe4a3; border-radius:14px; padding:10px 12px; display:flex; align-items:center; gap:10px; font-weight:700; box-shadow: 0 8px 20px rgba(245,158,11,.10)}
.dropzone .dz-item .emoji{width:28px;height:28px;border-radius:50%;display:grid;place-items:center; background:#fff;border:1px solid #ffe2b0;font-size:18px}
.dropzone .hint{color:#9aa0aa;text-align:center;margin:36px 0}

.actions{margin-top:10px;display:flex;gap:10px;flex-wrap:wrap}
button{border:1px solid #e7defc; background:linear-gradient(180deg,#f5f1ff,#efe8ff); border-radius:12px; padding:10px 14px; font-weight:800; cursor:pointer; box-shadow: var(--ring)}
button.primary{background: linear-gradient(180deg,#a78bfa,#8b5cf6); color:#fff; border-color:#8b5cf6}
button.success{background: linear-gradient(180deg,#34d399,#10b981); color:#fff; border-color:#10b981}
button.warn{background: linear-gradient(180deg,#fbbf24,#f59e0b); color:#fff; border-color:#f59e0b}

label{display:block;margin:6px 0 4px}
textarea,input,select{width:100%; padding:10px; border-radius:12px; border:1px solid #e7defc; background:#fff}

.kbd{font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace; padding:2px 6px; border:1px solid #e5e7eb; border-bottom-width:2px; border-radius:6px; background:#fff}
.toast{position:fixed; inset-inline:0; bottom:20px; margin-inline:auto; width:max-content; background:#111827; color:#fff; padding:10px 14px; border-radius:999px; box-shadow:0 10px 30px rgba(0,0,0,.25); font-weight:700; opacity:0; transform:translateY(10px); transition:.25s; z-index:9999}
.toast.show{opacity:1; transform:translateY(0)}

.helper{font-size:13px;color:var(--muted)}
  </style>
</head>
<body>
  <header>
    <h1>Ù†Ø´Ø§Ø· Ø§Ù„Ø®ÙˆØ§Ø±Ø²Ù…ÙŠØ§Øª â€” Ø±ØªÙ‘Ø¨ÙŠ Ø§Ù„Ø®Ø·ÙˆØ§Øª</h1>
    <p>Ø§Ø³Ø­Ø¨ÙŠ Ø§Ù„Ù…ÙƒÙˆÙ‘Ù†Ø§Øª Ù„ØªØ±ØªÙŠØ¨Ù‡Ø§ Ù…Ù† <strong>Ø§Ù„Ø£Ø³ÙÙ„ Ø¥Ù„Ù‰ Ø§Ù„Ø£Ø¹Ù„Ù‰</strong>ØŒ Ø«Ù… Ø§Ø³ØªØ®Ø¯Ù…ÙŠ Â«ØªØ­Ù‚Ù‘Ù‚ Ù…Ù† Ø§Ù„ØªØ±ØªÙŠØ¨Â» Ù„Ù„ØªØºØ°ÙŠØ© Ø§Ù„Ø±Ø§Ø¬Ø¹Ø© Ø§Ù„ÙÙˆØ±ÙŠØ©. ØªÙˆÙ„ÙŠØ¯ Ø§Ù„ØµÙˆØ± ÙŠØªÙ… Ø¹Ø¨Ø± <strong>ChatGPT Ù…Ø¨Ø§Ø´Ø±Ø©</strong> Ø¨Ø§Ø³ØªØ®Ø¯Ø§Ù… Ø§Ù„Ø¨Ø±ÙˆÙ…Ø¨Øª Ø§Ù„Ù…ÙÙ†Ø´Ø£ Ø£Ø¯Ù†Ø§Ù‡.</p>
  </header>

  <main>
    <!-- (1) Ø¥Ø¹Ø¯Ø§Ø¯ Ø§Ù„Ù†Ø´Ø§Ø· -->
    <section class="panel">
      <h2>Ø¥Ø¹Ø¯Ø§Ø¯ Ø§Ù„Ù†Ø´Ø§Ø·</h2>
      <div class="controls">
        <div class="row">
          <label for="recipe">Ø§Ù„ÙˆØµÙØ© Ø§Ù„Ø¬Ø§Ù‡Ø²Ø©</label>
          <select id="recipe" aria-label="Ø§Ø®ØªØ± ÙˆØµÙØ©"></select>
        </div>
        <div class="row" id="customBuilder" style="display:none">
          <label>Ø§Ù„ÙˆØ¶Ø¹ Ø§Ù„Ù…Ø®ØµØµ â€” Ø£Ø¶ÙŠÙÙŠ Ø¹Ù†Ø§ØµØ± Ø¨Ø§Ù„Ù„ØºØ© Ø§Ù„Ø¹Ø±Ø¨ÙŠØ© (Ø§Ø®ØªÙŠØ§Ø±ÙŠ Ø§ÙƒØªØ¨ÙŠ Ù…ÙØªØ§Ø­Ù‹Ø§ Ø¥Ù†Ø¬Ù„ÙŠØ²ÙŠÙ‹Ø§)</label>
          <div class="actions" style="gap:6px">
            <input id="addAr" placeholder="Ù…Ø«Ø§Ù„: Ø®Ø¨Ø² Ø³ÙÙ„ÙŠ / Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„Ø±ØµÙŠØ¯"/>
            <input id="addEn" placeholder="English key (optional)"/>
            <button id="addItem" class="primary">Ø¥Ø¶Ø§ÙØ© Ø¹Ù†ØµØ±</button>
            <button id="setAsAnswer" title="ØªØ¹Ø±ÙŠÙ Ø§Ù„ØªØ±ØªÙŠØ¨ Ø§Ù„Ø­Ø§Ù„ÙŠ ÙƒØ­Ù„ ØµØ­ÙŠØ­">ØªØ¹Ø±ÙŠÙ Ø§Ù„Ø­Ù„ Ø§Ù„ØµØ­ÙŠØ­</button>
          </div>
          <div class="helper">Ù†ØµÙŠØ­Ø©: Ø±ØªÙ‘Ø¨ÙŠ Ø§Ù„Ø¹Ù†Ø§ØµØ± ÙÙŠ Ù…Ù†Ø·Ù‚Ø© Ø§Ù„ØªØ±ØªÙŠØ¨ Ø«Ù… Ø§Ø¶ØºØ·ÙŠ Â«ØªØ¹Ø±ÙŠÙ Ø§Ù„Ø­Ù„ Ø§Ù„ØµØ­ÙŠØ­Â» Ù„ÙŠØ³ØªØ®Ø¯Ù…Ù‡ Ø²Ø± Â«ØªØ­Ù‚Ù‘Ù‚Â» Ù„Ø§Ø­Ù‚Ù‹Ø§.</div>
        </div>
        <div class="row">
          <label>Ø¥Ø¶Ø§ÙØ§Øª Ø§Ø®ØªÙŠØ§Ø±ÙŠØ© (ØªØ¸Ù‡Ø± Ø¶Ù…Ù† Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ù…ÙƒÙˆÙ†Ø§Øª)</label>
          <div id="addons" class="addons" aria-label="Ø¥Ø¶Ø§ÙØ§Øª"></div>
        </div>
        <div class="actions">
          <button id="applySetup" class="primary">ØªØ·Ø¨ÙŠÙ‚ Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯</button>
          <button id="resetAll" title="Ø¥Ø¹Ø§Ø¯Ø© ØªØ¹ÙŠÙŠÙ† ÙƒÙ„ Ø´ÙŠØ¡"><span class="kbd">âŸ²</span> Ø¥Ø¹Ø§Ø¯Ø© ØªØ¹ÙŠÙŠÙ†</button>
        </div>
      </div>
    </section>

    <!-- (2) Ù…ÙƒÙˆÙ†Ø§Øª Ø§Ù„Ù†Ø´Ø§Ø· -->
    <section class="panel">
      <h2>Ù…ÙƒÙˆÙ†Ø§Øª Ø§Ù„Ù†Ø´Ø§Ø· (Ù‚Ø§Ø¨Ù„Ø© Ù„Ù„Ø³Ø­Ø¨)</h2>
      <div id="ingredients" class="list" aria-label="Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ù…ÙƒÙˆÙ†Ø§Øª"></div>
      <div class="actions">
        <button id="shuffle">Ø®Ù„Ù‘Ø·ÙŠ</button>
        <button id="resetPool">Ø§Ø³ØªØ±Ø¬Ø§Ø¹ Ø§Ù„Ù…ÙƒÙˆÙ‘Ù†Ø§Øª</button>
      </div>
    </section>

    <!-- (3) Ø§Ù„ØªØ±ØªÙŠØ¨ Ø§Ù„ÙØ¹Ù„ÙŠ -->
    <section class="panel dropzone-panel">
      <h2>Ø§Ù„ØªØ±ØªÙŠØ¨ Ø§Ù„ÙØ¹Ù„ÙŠ (Ù…Ù† Ø§Ù„Ø£Ø³ÙÙ„ â†‘ Ø¥Ù„Ù‰ Ø§Ù„Ø£Ø¹Ù„Ù‰)</h2>
      <div id="dropzone" class="dropzone" aria-label="Ù…Ù†Ø·Ù‚Ø© ØªØ±ØªÙŠØ¨ Ø§Ù„Ø·Ø¨Ù‚Ø§Øª">
        <p class="hint">Ø§Ø³Ø­Ø¨ÙŠ Ø§Ù„Ø¹Ù†Ø§ØµØ± Ù‡Ù†Ø§</p>
      </div>
      <div class="actions">
        <button id="checkOrder" class="warn">ØªØ­Ù‚Ù‘Ù‚ Ù…Ù† Ø§Ù„ØªØ±ØªÙŠØ¨</button>
        <button id="showAnswer">Ø¥Ø¸Ù‡Ø§Ø± Ø§Ù„ØªØ±ØªÙŠØ¨ Ø§Ù„ØµØ­ÙŠØ­</button>
        <button id="clearDropzone">ØªÙØ±ÙŠØº</button>
        <button id="generatePrompt" class="success">Ø¥Ù†Ø´Ø§Ø¡ Ø¨Ø±ÙˆÙ…Ø¨Øª Ù„Ù€ ChatGPT</button>
      </div>
      <p id="score" aria-live="polite" style="color:var(--muted); margin:6px 0 0"></p>
    </section>

    <!-- (4) Ø¨Ø±ÙˆÙ…Ø¨Øª ChatGPT (Ù„Ù„ØªÙˆÙ„ÙŠØ¯ Ø§Ù„ÙŠØ¯ÙˆÙŠ) -->
    <section class="panel">
      <h2>ØªÙˆÙ„ÙŠØ¯ Ø§Ù„ØµÙˆØ± Ø¹Ø¨Ø± ChatGPT (Ø§Ù†Ø³Ø®ÙŠ Ø§Ù„Ø¨Ø±ÙˆÙ…Ø¨Øª)</h2>
      <label>English (to paste into ChatGPT Image)</label>
      <textarea id="promptEn" rows="5" readonly></textarea>
      <div class="actions">
        <button class="copy" data-target="promptEn">Copy EN</button>
        <button id="openChat">ÙØªØ­ ChatGPT ÙˆÙ„ØµÙ‚ Ø§Ù„Ø¨Ø±ÙˆÙ…Ø¨Øª</button>
      </div>
      <label>Ø§Ù„Ø¹Ø±Ø¨ÙŠØ© (Ù„Ù„Ø§Ø³ØªØ®Ø¯Ø§Ù… Ø¯Ø§Ø®Ù„ Ø§Ù„ØµÙ/Ø§Ù„ØªÙˆØ¶ÙŠØ­)</label>
      <textarea id="promptAr" rows="4" readonly></textarea>
      <div class="actions"><button class="copy" data-target="promptAr">Ø§Ù†Ø³Ø® AR</button></div>
      <div class="helper">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø£ÙŠ Ø§ØªØµØ§Ù„Ø§Øª Ø®Ø§Ø±Ø¬ÙŠØ© â€” Ø§Ù„Ø²Ø± Ø£Ø¹Ù„Ø§Ù‡ ÙŠÙ†Ø³Ø® Ø§Ù„Ø¨Ø±ÙˆÙ…Ø¨Øª ØªÙ„Ù‚Ø§Ø¦ÙŠÙ‹Ø§ ÙˆÙŠÙØªØ­ ChatGPT ÙÙŠ ØªØ¨ÙˆÙŠØ¨ Ø¬Ø¯ÙŠØ¯ Ù„ØªÙ„ØµÙ‚ÙŠÙ‡ Ù‡Ù†Ø§Ùƒ.</div>
    </section>
  </main>

  <footer>
    <p>Â© Ù†Ø³Ø®Ø© Ù…Ø¨Ø³Ø·Ø© â€” Ù„Ø§ ØªØ­ØªÙˆÙŠ Ø£ÙŠ Ø±Ø¨Ø· Ø¨ÙˆØ§Ø¬Ù‡Ø§Øª Ø®Ø§Ø±Ø¬ÙŠØ©.</p>
  </footer>

  <!-- Ø³ÙƒØ±Ø¨Øª Ø§Ù„ØªØ·Ø¨ÙŠÙ‚ (Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ø£ÙŠ Ø§Ø³ØªØ¯Ø¹Ø§Ø¡ API) -->
  <script>
  /*****************************
   *  Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„ÙˆØµÙØ§Øª Ø§Ù„Ø¬Ø§Ù‡Ø²Ø©   *
   *****************************/
  const RECIPES = {
    burger: {
      nameAr: 'Ø¨Ø±Ù‚Ø±', nameEn: 'classic burger',
      ingredients: [
        {key:'bottom bun', ar:'Ø®Ø¨Ø² Ø³ÙÙ„ÙŠ', emoji:'ğŸ'},
        {key:'lettuce', ar:'Ø®Ø³', emoji:'ğŸ¥¬'},
        {key:'beef patty', ar:'Ù„Ø­Ù… Ø¨Ø±Ù‚Ø±', emoji:'ğŸ–'},
        {key:'cheese slice', ar:'Ø¬Ø¨Ù†', emoji:'ğŸ§€'},
        {key:'tomato', ar:'Ø·Ù…Ø§Ø·Ù…', emoji:'ğŸ…'},
        {key:'top bun', ar:'Ø®Ø¨Ø² Ø¹Ù„ÙˆÙŠ', emoji:'ğŸ'},
      ],
      correct: ['bottom bun','lettuce','beef patty','cheese slice','tomato','top bun']
    },
    grape: {
      nameAr: 'ÙˆØ±Ù‚ Ø¹Ù†Ø¨', nameEn: 'grape leaves wrap',
      ingredients: [
        {key:'grape leaf', ar:'ÙˆØ±Ù‚Ø© Ø¹Ù†Ø¨', emoji:'ğŸƒ'},
        {key:'rice filling', ar:'Ø­Ø´ÙˆØ© Ø±Ø²', emoji:'ğŸš'},
        {key:'roll', ar:'Ù„ÙÙ‘/Ø¥ØºÙ„Ø§Ù‚', emoji:'ğŸŒ€'},
        {key:'stack in pot', ar:'Ø±ØµÙ‘ ÙÙŠ Ø§Ù„Ù‚Ø¯Ø±', emoji:'ğŸ²'},
        {key:'add sauce', ar:'Ø¥Ø¶Ø§ÙØ© ØµÙ„ØµØ©/Ù…Ø±Ù‚', emoji:'ğŸ¥«'},
        {key:'cook', ar:'Ø·Ø¨Ø®/ØªØ³ÙˆÙŠØ©', emoji:'ğŸ”¥'},
      ],
      correct: ['grape leaf','rice filling','roll','stack in pot','add sauce','cook']
    },
    morning: {
      nameAr: 'Ø±ÙˆØªÙŠÙ† Ø§Ù„ØµØ¨Ø§Ø­', nameEn: 'morning routine',
      ingredients: [
        {key:'wake up', ar:'Ø§Ø³ØªÙŠÙ‚Ø§Ø¸', emoji:'â°'},
        {key:'wash face', ar:'ØºØ³Ù„ Ø§Ù„ÙˆØ¬Ù‡/Ø§Ù„Ø£Ø³Ù†Ø§Ù†', emoji:'ğŸª¥'},
        {key:'breakfast', ar:'Ø¥ÙØ·Ø§Ø±', emoji:'ğŸ¥£'},
        {key:'pack bag', ar:'ØªØ¬Ù‡ÙŠØ² Ø§Ù„Ø­Ù‚ÙŠØ¨Ø©', emoji:'ğŸ’'},
        {key:'get dressed', ar:'Ø§Ù„Ù„Ø¨Ø§Ø³', emoji:'ğŸ‘•'},
        {key:'go to school', ar:'Ø§Ù„Ø°Ù‡Ø§Ø¨ Ø¥Ù„Ù‰ Ø§Ù„Ù…Ø¯Ø±Ø³Ø©', emoji:'ğŸ«'},
      ],
      correct: ['wake up','wash face','breakfast','pack bag','get dressed','go to school']
    },
    atm: {
      nameAr: 'Ø³Ø­Ø¨ Ù…Ù† Ø§Ù„ØµØ±Ø§Ù (ATM)', nameEn: 'ATM cash withdrawal',
      ingredients: [
        {key:'insert card', ar:'Ø¥Ø¯Ø®Ø§Ù„ Ø§Ù„Ø¨Ø·Ø§Ù‚Ø©', emoji:'ğŸ’³'},
        {key:'choose language', ar:'Ø§Ø®ØªÙŠØ§Ø± Ø§Ù„Ù„ØºØ©', emoji:'ğŸŒ'},
        {key:'enter pin', ar:'Ø¥Ø¯Ø®Ø§Ù„ Ø§Ù„Ø±Ù‚Ù… Ø§Ù„Ø³Ø±ÙŠ', emoji:'ğŸ”¢'},
        {key:'select withdraw', ar:'Ø§Ø®ØªÙŠØ§Ø± Ø³Ø­Ø¨ Ù†Ù‚Ø¯ÙŠ', emoji:'ğŸ§'},
        {key:'enter amount', ar:'ØªØ­Ø¯ÙŠØ¯ Ø§Ù„Ù…Ø¨Ù„Øº', emoji:'ğŸ’µ'},
        {key:'take cash & card', ar:'Ø§Ø³ØªÙ„Ø§Ù… Ø§Ù„Ù†Ù‚ÙˆØ¯ ÙˆØ§Ù„Ø¨Ø·Ø§Ù‚Ø©/Ø§Ù„Ø¥ÙŠØµØ§Ù„', emoji:'ğŸ§¾'},
      ],
      correct: ['insert card','choose language','enter pin','select withdraw','enter amount','take cash & card']
    },
    custom: { nameAr: 'Ù…Ø®ØµØµ', nameEn: 'custom', ingredients: [], correct: [] }
  };

  const GLOBAL_ADDONS = [
    {key:'onion', ar:'Ø¨ØµÙ„', emoji:'ğŸ§…'},
    {key:'cucumber', ar:'Ø®ÙŠØ§Ø±', emoji:'ğŸ¥’'},
    {key:'ketchup', ar:'ÙƒØ§ØªØ´Ø¨', emoji:'ğŸ…'},
    {key:'mayo', ar:'Ù…Ø§ÙŠÙˆÙ†ÙŠØ²', emoji:'ğŸ¥«'},
    {key:'hot sauce', ar:'Ø´Ø·Ø©', emoji:'ğŸŒ¶ï¸'},
  ];

  /*****************************
   * Ø¹Ù†Ø§ØµØ± DOM
   *****************************/
  const recipeSelect = document.getElementById('recipe');
  const addonsWrap   = document.getElementById('addons');
  const applySetup   = document.getElementById('applySetup');
  const resetAllBtn  = document.getElementById('resetAll');
  const ingredients  = document.getElementById('ingredients');
  const dropzone     = document.getElementById('dropzone');
  const shuffleBtn   = document.getElementById('shuffle');
  const resetPoolBtn = document.getElementById('resetPool');
  const clearDZBtn   = document.getElementById('clearDropzone');
  const checkBtn     = document.getElementById('checkOrder');
  const showAnsBtn   = document.getElementById('showAnswer');
  const scoreP       = document.getElementById('score');
  const customWrap   = document.getElementById('customBuilder');
  const addAr        = document.getElementById('addAr');
  const addEn        = document.getElementById('addEn');
  const addItemBtn   = document.getElementById('addItem');
  const setAsAnswer  = document.getElementById('setAsAnswer');
  const genPromptBtn = document.getElementById('generatePrompt');
  const promptEn     = document.getElementById('promptEn');
  const promptAr     = document.getElementById('promptAr');

  /*****************************
   *   Ù…Ø³Ø§Ø¹Ø¯Ø§Øª ÙˆØ§Ø¬Ù‡Ø©
   *****************************/
  function showToast(msg='ØªÙ…!'){
    let t = document.querySelector('.toast');
    if(!t){ t = document.createElement('div'); t.className = 'toast'; document.body.appendChild(t); }
    t.textContent = msg; t.classList.add('show');
    setTimeout(()=>t.classList.remove('show'), 1600);
  }

  function el(tag, props={}, ...children){
    const e = document.createElement(tag);
    Object.entries(props||{}).forEach(([k,v])=>{
      if(k==='class') e.className = v;
      else if(k==='dataset') Object.assign(e.dataset, v);
      else if(k.startsWith('on') && typeof v==='function') e.addEventListener(k.substring(2), v);
      else e.setAttribute(k,v);
    });
    for(const c of children){ if(c==null) continue; if(typeof c==='string') e.appendChild(document.createTextNode(c)); else e.appendChild(c); }
    return e;
  }

  function shuffleArray(arr){ const a=[...arr]; for(let i=a.length-1;i>0;i--){ const j=Math.floor(Math.random()*(i+1)); [a[i],a[j]]=[a[j],a[i]]; } return a; }
  function currentRecipe(){ return RECIPES[recipeSelect.value] || RECIPES.burger; }

  /*****************************
   *   Ø¥Ø¹Ø¯Ø§Ø¯ Ø§Ù„Ù†Ø´Ø§Ø·
   *****************************/
  function renderSetup(){
    recipeSelect.innerHTML = '';
    for(const [id,rec] of Object.entries(RECIPES)){
      recipeSelect.appendChild(el('option', {value:id}, rec.nameAr));
    }
    addonsWrap.innerHTML = '';
    GLOBAL_ADDONS.forEach(a=>{
      const id = `addon-${a.key}`;
      const chip = el('label', {class:'addon', for:id},
        el('input', {type:'checkbox', id, 'data-key':a.key}),
        el('span', {}, `${a.emoji} ${a.ar}`)
      );
      addonsWrap.appendChild(chip);
    });
  }

  /*****************************
   *   Ø§Ù„Ù…ÙƒÙˆÙ‘Ù†Ø§Øª (Ø§Ù„Ù‚Ø§Ø¨Ù„Ø© Ù„Ù„Ø³Ø­Ø¨)
   *****************************/
  let poolSnapshot = [];
  function buildPool(){
    const base = currentRecipe().ingredients.map(it=>({...it, origin:'base'}));
    const addonKeys = [...addonsWrap.querySelectorAll('input:checked')].map(inp=>inp.dataset.key);
    const extras = GLOBAL_ADDONS.filter(a=>addonKeys.includes(a.key)).map(it=>({...it, origin:'addon'}));
    const pool = [...base, ...extras];
    renderPool(pool); poolSnapshot = pool;
    customWrap.style.display = (recipeSelect.value==='custom') ? 'block' : 'none';
  }

  function renderPool(items){
    ingredients.innerHTML = '';
    items.forEach(it=>{
      const node = el('div', {class:'item', draggable:'true', role:'button', tabindex:'0', dataset:{en:it.key, ar:it.ar}},
        el('span', {class:'emoji'}, it.emoji || 'ğŸ”¹'), ` ${it.ar}`
      );
      enableDrag(node); ingredients.appendChild(node);
    });
  }
  function restorePool(){ renderPool(poolSnapshot); }

  // Ø¥Ø¶Ø§ÙØ© Ø¹Ù†ØµØ± Ù…Ø®ØµØµ
  addItemBtn.addEventListener('click', ()=>{
    if(recipeSelect.value!=='custom'){ showToast('Ø¨Ø¯Ù‘Ù„ÙŠ Ø¥Ù„Ù‰ "Ù…Ø®ØµØµ" Ø£ÙˆÙ„Ù‹Ø§'); return; }
    const ar = (addAr.value||'').trim();
    const en = (addEn.value||ar).trim() || 'custom-item';
    if(!ar){ showToast('Ø£Ø¯Ø®Ù„ÙŠ Ø§Ø³Ù… Ø§Ù„Ø¹Ù†ØµØ± Ø¨Ø§Ù„Ø¹Ø±Ø¨ÙŠØ©'); return; }
    const item = {key:en, ar, emoji:'ğŸ”¹'};
    poolSnapshot.push(item); renderPool(poolSnapshot);
    addAr.value=''; addEn.value=''; showToast('ØªÙ…Øª Ø§Ù„Ø¥Ø¶Ø§ÙØ©');
  });

  // Ø­ÙØ¸ Ø§Ù„ØªØ±ØªÙŠØ¨ Ø§Ù„Ø­Ø§Ù„ÙŠ ÙƒØ­Ù„ ØµØ­ÙŠØ­ Ù„Ù„ÙˆØ¶Ø¹ Ø§Ù„Ù…Ø®ØµØµ
  setAsAnswer.addEventListener('click', ()=>{
    if(recipeSelect.value!=='custom'){ showToast('Ù‡Ø°Ù‡ Ø§Ù„ÙˆØ¸ÙŠÙØ© Ù„Ù„ÙˆØ¶Ø¹ Ø§Ù„Ù…Ø®ØµØµ ÙÙ‚Ø·'); return; }
    const arr = getDZOrder();
    localStorage.setItem('custom_correct', JSON.stringify(arr));
    showToast('ØªÙ… ØªØ¹Ø±ÙŠÙ Ø§Ù„Ø­Ù„ Ø§Ù„ØµØ­ÙŠØ­');
  });

  /*****************************
   *   Ø§Ù„Ø³Ø­Ø¨ ÙˆØ§Ù„Ø¥ÙÙ„Ø§Øª
   *****************************/
  function enableDrag(node){
    node.addEventListener('dragstart', (e)=>{ e.dataTransfer.setData('text/plain', JSON.stringify(node.dataset)); setTimeout(()=>node.classList.add('dragging'),0); });
    node.addEventListener('dragend', ()=> node.classList.remove('dragging'));
    node.addEventListener('keydown', (e)=>{ if(e.key==='Enter' || e.key===' '){ addToDropzone(node.dataset); showToast('Ø£ÙØ¶ÙŠÙØª Ù„Ù„Ø·Ø¨Ù‚Ø§Øª'); } });
  }
  dropzone.addEventListener('dragover', (e)=>{ e.preventDefault(); dropzone.classList.add('over'); });
  dropzone.addEventListener('dragleave', ()=> dropzone.classList.remove('over'));
  dropzone.addEventListener('drop', (e)=>{ e.preventDefault(); dropzone.classList.remove('over'); try{ const data = JSON.parse(e.dataTransfer.getData('text/plain')); addToDropzone(data);}catch{} });

  function addToDropzone(data){
    const node = el('div', {class:'dz-item', draggable:'true', dataset:{en:data.en, ar:data.ar}},
      el('span', {class:'emoji'}, 'ğŸ½ï¸'), ` ${data.ar}`
    );
    node.addEventListener('dragstart', (e)=>{ e.dataTransfer.setData('text/plain', 'reorder'); node.classList.add('dragging'); });
    node.addEventListener('dragend', ()=> node.classList.remove('dragging'));
    dropzone.appendChild(node); dropzone.querySelector('.hint')?.remove();

    const items = [...dropzone.querySelectorAll('.dz-item')];
    items.forEach(it=>{
      it.addEventListener('dragover', (e)=>{
        e.preventDefault();
        const dragging = dropzone.querySelector('.dz-item.dragging');
        if(!dragging || dragging===it) return;
        dropzone.insertBefore(dragging, it);
      });
    });
  }

  function getDZOrder(){ return [...dropzone.querySelectorAll('.dz-item')].map(n=>n.dataset.en); }
  function getDZOrderAr(){ return [...dropzone.querySelectorAll('.dz-item')].map(n=>n.dataset.ar); }
  function clearDropzone(){ dropzone.innerHTML = '<p class="hint">Ø§Ø³Ø­Ø¨ÙŠ Ø§Ù„Ø¹Ù†Ø§ØµØ± Ù‡Ù†Ø§</p>'; scoreP.textContent = ''; }

  /*****************************
   *   Ø§Ù„ØªØ­Ù‚Ù‘Ù‚/Ø§Ù„ØªØºØ°ÙŠØ© Ø§Ù„Ø±Ø§Ø¬Ø¹Ø©
   *****************************/
  function getCorrect(){
    if(recipeSelect.value==='custom'){
      try { return JSON.parse(localStorage.getItem('custom_correct')||'[]'); } catch { return []; }
    }
    return currentRecipe().correct;
  }

  function checkOrder(){
    const target = getCorrect();
    const actual = getDZOrder();
    if(actual.length===0){ showToast('Ø¶Ø¹ÙŠ Ø¨Ø¹Ø¶ Ø§Ù„Ø·Ø¨Ù‚Ø§Øª Ø£ÙˆÙ„Ø§Ù‹'); return; }
    if(target.length===0 && recipeSelect.value==='custom'){
      scoreP.textContent = 'Ù„Ù… ÙŠØªÙ… ØªØ¹Ø±ÙŠÙ Ø­Ù„ ØµØ­ÙŠØ­ Ø¨Ø¹Ø¯ Ù„Ù„ÙˆØ¶Ø¹ Ø§Ù„Ù…Ø®ØµØµ â€” Ø§Ø³ØªØ®Ø¯Ù…ÙŠ "ØªØ¹Ø±ÙŠÙ Ø§Ù„Ø­Ù„ Ø§Ù„ØµØ­ÙŠØ­".'; return;
    }
    const nodes = [...dropzone.querySelectorAll('.dz-item')];
    let correct = 0;
    nodes.forEach((n,i)=>{
      n.classList.remove('good','bad');
      if(target[i]===actual[i]){ n.classList.add('good'); correct++; }
      else n.classList.add('bad');
    });
    const pct = Math.round((correct/target.length)*100);
    scoreP.textContent = `Ø§Ù„Ù†ØªÙŠØ¬Ø©: ${correct} / ${target.length} (${pct}Ùª) â€” ${(correct===target.length)?'ØªØ±ØªÙŠØ¨ ØµØ­ÙŠØ­! âœ…':'Ø­Ø§ÙˆÙ„ÙŠ ØªØ­Ø³ÙŠÙ† Ø§Ù„ØªØ±ØªÙŠØ¨ ğŸ˜Š'}`;
  }
  function showAnswer(){
    const correct = getCorrect();
    if(recipeSelect.value==='custom' && correct.length===0){ showToast('Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ø­Ù„ Ù…Ø¹Ø±Ù Ø¨Ø¹Ø¯'); return; }
    clearDropzone();
    const src = [...(currentRecipe().ingredients||[]), ...GLOBAL_ADDONS, ...poolSnapshot];
    correct.forEach(key=>{ const found = src.find(x=>x.key===key); if(found) addToDropzone({en:found.key, ar:found.ar}); });
  }

  /*****************************
   *  ØªÙˆÙ„ÙŠØ¯ Ø¨Ø±ÙˆÙ…Ø¨Øª Ù„ÙÙ€ ChatGPT
   *****************************/
  function generatePrompt(){
    const rec = currentRecipe();
    const enLayers = getDZOrder();
    const arLayers = getDZOrderAr();
    if(enLayers.length===0){ showToast('Ø±ØªÙ‘Ø¨ÙŠ Ø¨Ø¹Ø¶ Ø§Ù„Ø·Ø¨Ù‚Ø§Øª Ø£ÙˆÙ„Ø§Ù‹'); return; }

    const topic = rec.nameEn || 'custom';
    const en = `Create a clean, classroom-friendly flat illustration of ${topic}. Show layers bottom-to-top in this exact order: ${enLayers.join(', ')}. Neutral background, simple shapes, soft shadows.`;
    const ar = `ÙˆÙ„Ù‘Ø¯ÙŠ ØµÙˆØ±Ø© ${rec.nameAr} Ø¨ØªØ±ØªÙŠØ¨ Ù…Ù† Ø§Ù„Ø£Ø³ÙÙ„ Ø¥Ù„Ù‰ Ø§Ù„Ø£Ø¹Ù„Ù‰: ${arLayers.join('ØŒ ')}. Ø¨Ø£Ø³Ù„ÙˆØ¨ ØªÙˆØ¶ÙŠØ­ÙŠ ØµÙÙŠ ÙˆØ®Ù„ÙÙŠØ© Ø¨Ø³ÙŠØ·Ø©.`;

    document.getElementById('promptEn').value = en;
    document.getElementById('promptAr').value = ar;
    showToast('ØªÙ… Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ø¨Ø±ÙˆÙ…Ø¨Øª! Ø§Ù†Ø³Ø®ÙŠ Ø§Ù„Ù†Øµ ÙˆØ£Ù„ØµÙ‚ÙŠÙ‡ ÙÙŠ ChatGPT');
  }

  /*****************************
   *   Ø§Ù„Ø£Ø­Ø¯Ø§Ø« ÙˆØ§Ù„ØªØ´ØºÙŠÙ„
   *****************************/
  function bindEvents(){
    applySetup.addEventListener('click', ()=>{ buildPool(); clearDropzone(); showToast('ØªÙ… ØªØ·Ø¨ÙŠÙ‚ Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯'); });

    resetAllBtn.addEventListener('click', ()=>{
      [...addonsWrap.querySelectorAll('input')].forEach(i=>i.checked=false);
      recipeSelect.value='burger'; buildPool(); clearDropzone();
      localStorage.removeItem('custom_correct');
      showToast('ØªÙ…Øª Ø¥Ø¹Ø§Ø¯Ø© Ø§Ù„ØªØ¹ÙŠÙŠÙ†');
    });

    shuffleBtn.addEventListener('click', ()=>{
      const items=[...ingredients.querySelectorAll('.item')].map(n=>({
        en:n.dataset.en, ar:n.dataset.ar, emoji:n.querySelector('.emoji')?.textContent||'ğŸ”¹'
      }));
      renderPool(shuffleArray(items));
    });

    resetPoolBtn.addEventListener('click', restorePool);
    clearDZBtn.addEventListener('click', clearDropzone);
    checkBtn.addEventListener('click', checkOrder);
    showAnsBtn.addEventListener('click', showAnswer);
    genPromptBtn.addEventListener('click', generatePrompt);

    document.querySelectorAll('.copy').forEach(btn=> btn.addEventListener('click', ()=>{
      const id=btn.dataset.target; const ta=document.getElementById(id);
      if(!ta) return; ta.select(); document.execCommand('copy');
      showToast('Copied!');
    }));

    const openBtn = document.getElementById('openChat');
    if(openBtn){
      openBtn.addEventListener('click', ()=>{
        const ta = document.getElementById('promptEn');
        if(ta && ta.value.trim()){
          ta.select(); document.execCommand('copy');
          showToast('ØªÙ… Ù†Ø³Ø® Ø§Ù„Ø¨Ø±ÙˆÙ…Ø¨Øª!');
        } else { showToast('Ø£Ù†Ø´Ø¦ÙŠ Ø§Ù„Ø¨Ø±ÙˆÙ…Ø¨Øª Ø£ÙˆÙ„Ø§Ù‹'); }
        window.open('https://chat.openai.com/', '_blank');
      });
    }
  }

  window.addEventListener('DOMContentLoaded', ()=>{ renderSetup(); recipeSelect.value='burger'; buildPool(); bindEvents(); });
  </script>

  <!-- Ø¹Ù†ØµØ± Ø§Ù„ØªÙˆØ³Øª -->
  <div class="toast" aria-live="polite"></div>
</body>
</html>
